/* Debug-enabled collapse list controller (bundle asset) */
(function(){
  function dbg(){ try { console.log.apply(console, ['[collapse-list]'].concat([].slice.call(arguments))); } catch(e){} }
  function each(nl, cb){ for (var i=0;i<nl.length;i++){ cb(nl[i], i); } }
  function Controller(){ this.elements={buttons:[], wrappers:[]}; this.settings={maxWidthBreakpoint:560}; this.state={collapsed:true,isMobile:false}; this._wrapperClasses=[]; this._btnStyles=[]; }
  Controller.prototype.init=function(c){ if(!c){dbg('init:no container');return;} if(c.dataset&&c.dataset.clInit==='1'){dbg('init:skip duplicate');return;} this.elements.container=c; var sel=c.getAttribute('data-collapse-list'); this.elements.list=c.querySelector(sel); if(!this.elements.list){ console.error('collapse-list: list selector not found', sel); return;} dbg('init: ok, items', this.elements.list.children.length); this.findOrCreateButtons(); try{ var ro=new ResizeObserver(this.onResize.bind(this)); ro.observe(c); this.onResize([{contentRect:{width:c.getBoundingClientRect().width}}]); }catch(e){ this.onResize([{contentRect:{width:c.getBoundingClientRect().width}}]); dbg('init: ResizeObserver not available or failed'); } for (var i=0;i<this.elements.buttons.length;i++){ this.elements.buttons[i].addEventListener('click', this.onClick.bind(this)); } if(c.dataset) c.dataset.clInit='1'; };
  Controller.prototype.onResize=function(entries){ var w=null; try{ each(entries,function(e){ w=(e.contentBoxSize? (e.contentBoxSize[0]||e.contentBoxSize).inlineSize : e.contentRect.width); }); }catch(_){} var cw=this.elements.container.getBoundingClientRect().width; var mobile=((w!==null?w:cw) <= this.settings.maxWidthBreakpoint); dbg('resize width=', w||cw, 'isMobile=', mobile); this.setState('isMobile', mobile); };
  Controller.prototype.onClick=function(){ dbg('click collapsed->', !this.state.collapsed); this.setState('collapsed', !this.state.collapsed); if(this.state.collapsed){ try{ this.elements.container.scrollIntoView(); }catch(e){} } };
  Controller.prototype.getButtonText=function(){ if(this.state.collapsed){ var total=this.elements.list?this.elements.list.children.length:0; return 'Alle '+total+' Niederlassungen anzeigen'; } return 'Niederlassungen einklappen'; };
  Controller.prototype._rememberWrapper=function(btn){
    try {
      var wrap = btn.closest && btn.closest('.button');
      if (wrap) {
        this.elements.wrappers.push(wrap);
        this._wrapperClasses.push(wrap.className);
      } else {
        this.elements.wrappers.push(null);
        this._wrapperClasses.push('');
      }
      // Snapshot computed styles of the button to force same appearance on touch (ignore :hover changes)
      try {
        var cs = window.getComputedStyle(btn);
        this._btnStyles.push({
          backgroundColor: cs.backgroundColor,
          color: cs.color,
          borderColor: cs.borderColor
        });
      } catch(e){ this._btnStyles.push(null); }
    } catch(e){ this.elements.wrappers.push(null); this._wrapperClasses.push(''); }
  };
  Controller.prototype._restoreWrapperClasses=function(){
    for (var i=0;i<this.elements.wrappers.length;i++){
      var w = this.elements.wrappers[i];
      var cls = this._wrapperClasses[i];
      if (w && cls) { w.className = cls; }
    }
  };
  Controller.prototype.findOrCreateButtons=function(){
    // 1) Inside container
    var inside = this.elements.container.querySelectorAll('.collapse-list__button button');
    if (inside && inside.length){ for (var i=0;i<inside.length;i++){ this.elements.buttons.push(inside[i]); this._rememberWrapper(inside[i]); } dbg('button: reused inside x', inside.length); this.updateButtonLabels(); return; }
    // 2) Siblings (previous/next)
    var sibs = [];
    var prev = this.elements.container.previousElementSibling;
    if (prev && prev.classList && prev.classList.contains('collapse-list__button')){ var b1=prev.querySelector('button'); if(b1) sibs.push(b1); }
    var next = this.elements.container.nextElementSibling;
    if (next && next.classList && next.classList.contains('collapse-list__button')){ var b2=next.querySelector('button'); if(b2) sibs.push(b2); }
    if (sibs.length){ for (var j=0;j<sibs.length;j++){ this.elements.buttons.push(sibs[j]); this._rememberWrapper(sibs[j]); } dbg('button: reused sibling x', sibs.length); this.updateButtonLabels(); return; }
    // 3) Create one inside container
    var wrap=document.createElement('div'); wrap.classList.add('collapse-list__button');
    var inner=document.createElement('div'); inner.classList.add('button','button_default','button-color_pink');
    var btn=document.createElement('button'); btn.textContent=this.getButtonText();
    inner.append(btn); wrap.append(inner); this.elements.container.append(wrap);
    this.elements.buttons.push(btn);
    this._rememberWrapper(btn);
    dbg('button: created new');
  };
  Controller.prototype.updateButtonLabels=function(){ var label=this.getButtonText(); for (var i=0;i<this.elements.buttons.length;i++){ this.elements.buttons[i].textContent=label; } };
  Controller.prototype.render=function(){ var active=this.state.isMobile?'true':'false'; var collapsed=(this.state.isMobile&&this.state.collapsed)?'true':'false'; this.elements.container.setAttribute('data-active', active); this.elements.container.setAttribute('data-collapsed', collapsed); this.updateButtonLabels(); this._restoreWrapperClasses();
    // Re-apply captured inline styles to defeat :hover visual change on touch
    for (var i=0;i<this.elements.buttons.length;i++){
      try{
        var b=this.elements.buttons[i], st=this._btnStyles[i];
        if (b && st){ b.style.backgroundColor = st.backgroundColor; b.style.color = st.color; b.style.borderColor = st.borderColor; }
      }catch(e){}
    }
    dbg('render active=',active,'collapsed=',collapsed,'label=', (this.elements.buttons[0]&&this.elements.buttons[0].textContent)); };
  Controller.prototype.setState=function(k,v){ this.state[k]=v; this.render(); };
  function boot(){ var nodes=document.querySelectorAll('[data-module="collapse-list"]'); window.__collapseListBoot=(window.__collapseListBoot||0)+1; dbg('boot containers=', nodes.length, 'bootCount=', window.__collapseListBoot); each(nodes,function(el){ try{ (new Controller()).init(el); }catch(e){ console.error(e); } }); }
  if(document.readyState==='interactive'||document.readyState==='complete') boot(); else document.addEventListener('DOMContentLoaded', boot);
})();
